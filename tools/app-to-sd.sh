#!/bin/bash

# run in subshell
(

BUSYBOX_VER=1.30.1

# error handling
set -e

err_report() {
    echo "---------------------------------------------------------------------"
    echo "                            FAILED!"
    echo "Script failed while executing"
    echo ""
    echo "line $1 : ${@:2}."
    echo ""
    echo "---------------------------------------------------------------------"
}

# make sysfs applicaiton
echo "-------------------------------------------------------------------------"
echo "  Calling sysfs make..."
echo "-------------------------------------------------------------------------"
cd sysfs_app/
make
cd -
echo "-------------------------------------------------------------------------"
echo "                          ... done!"
echo "-------------------------------------------------------------------------"

echo "-------------------------------------------------------------------------"
echo " Calling chardev make..."
echo "-------------------------------------------------------------------------"
cd chardev_app/
make
cd -
echo "-------------------------------------------------------------------------"
echo "                          ... done!"
echo "-------------------------------------------------------------------------"

echo "-------------------------------------------------------------------------"
echo " Copying proper files to boot partition..."
echo "-------------------------------------------------------------------------"
sudo cp boot.scr /mnt/boot/
sudo cp ../linux/arch/arm/boot/zImage /mnt/boot/
sudo cp ../linux/arch/arm/boot/dts/vexpress-v2p-ca9.dtb /mnt/boot/
echo "-------------------------------------------------------------------------"
echo "                          ... done!"
echo "-------------------------------------------------------------------------"

echo "-------------------------------------------------------------------------"
echo " Copying proper files to rootfs partition ..."
echo "-------------------------------------------------------------------------"
sudo rm /mnt/rootfs/home/sysfs_app 
sudo cp sysfs_app/sysfs_app /mnt/rootfs/home/
sudo rm /mnt/rootfs/home/chardev_app 
sudo cp chardev_app/chardev_app /mnt/rootfs/home/
echo "-------------------------------------------------------------------------"
echo "                          ... done!"
echo "-------------------------------------------------------------------------"
 
)
