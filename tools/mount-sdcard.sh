#!/bin/bash

# run in subshell
(

# error handling
set -e

err_report() {
    echo "---------------------------------------------------------------------"
    echo "                            FAILED!"
    echo "Script failed while executing"
    echo ""
    echo "line $1 : ${@:2}."
    echo ""
    echo "---------------------------------------------------------------------"
}

trap 'err_report $LINENO $BASH_COMMAND' ERR

SDIMG_NAME=sd.img

# insert SD card
echo "-------------------------------------------------------------------------"
echo " Mapping SD card image ..."
echo "-------------------------------------------------------------------------"
loop_nr=$(sudo kpartx -av ${SDIMG_NAME} | grep -Po 'loop.+?(?=p)' | tail -1)
sleep 1
echo $loop_nr
echo "-------------------------------------------------------------------------"
echo "                       ... done!"
echo "-------------------------------------------------------------------------"

# mount boot partition
echo "-------------------------------------------------------------------------"
echo " Mounting boot partition ..."
echo "-------------------------------------------------------------------------"
sudo mkdir -p /mnt/boot
sudo mount -t vfat /dev/mapper/${loop_nr}p1 /mnt/boot
echo "-------------------------------------------------------------------------"
echo "                         ... done!"
echo "-------------------------------------------------------------------------"

# mount rootfs partition
echo "-------------------------------------------------------------------------"
echo " Mounting rootfs partition ..."
echo "-------------------------------------------------------------------------"
sudo mkdir -p /mnt/rootfs
sudo mount -t ext4 /dev/mapper/${loop_nr}p2 /mnt/rootfs
echo "-------------------------------------------------------------------------"
echo "                           ... done!"
echo "-------------------------------------------------------------------------"

echo "-------------------------------------------------------------------------"
echo "                Finished mounting SD Card ${SDIMG_NAME}!"
echo "-------------------------------------------------------------------------"

)
