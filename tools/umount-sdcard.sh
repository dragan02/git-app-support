#!/bin/bash

# run in subshell
(

# error handling
set -e

err_report() {
    echo "---------------------------------------------------------------------"
    echo "                            FAILED!"
    echo "Script failed while executing"
    echo ""
    echo "line $1 : ${@:2}."
    echo ""
    echo "---------------------------------------------------------------------"
}

trap 'err_report $LINENO $BASH_COMMAND' ERR

SDIMG_NAME=sd.img

# umount boot partition
echo "-------------------------------------------------------------------------"
echo " Umounting boot partition ..."
echo "-------------------------------------------------------------------------"
sudo umount /mnt/boot
echo "-------------------------------------------------------------------------"
echo "                          ... done!"
echo "-------------------------------------------------------------------------"

# umount rootfs partition
echo "-------------------------------------------------------------------------"
echo " Umounting rootfs partition ..."
echo "-------------------------------------------------------------------------"
sudo umount /mnt/rootfs
echo "-------------------------------------------------------------------------"
echo "                            ... done!"
echo "-------------------------------------------------------------------------"

# remove SD card
echo "-------------------------------------------------------------------------"
echo " Unmapping SD card image ..."
echo "-------------------------------------------------------------------------"
sudo kpartx -d ${SDIMG_NAME}
echo "-------------------------------------------------------------------------"
echo "                       ... done!"
echo "-------------------------------------------------------------------------"



echo "-------------------------------------------------------------------------"
echo "                Finished umounting SD Card ${SDIMG_NAME}!"
echo "                        You can use it now!"
echo "-------------------------------------------------------------------------"

)
