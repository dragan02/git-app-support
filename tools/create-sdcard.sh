#!/bin/bash

# run in subshell
(

# error handling
set -e

err_report() {
    echo "---------------------------------------------------------------------"
    echo "                            FAILED!"
    echo "Script failed while executing"
    echo ""
    echo "line $1 : ${@:2}."
    echo ""
    echo "---------------------------------------------------------------------"
}

trap 'err_report $LINENO $BASH_COMMAND' ERR

# request information
read -p "Enter name for SD card image? [sd.img] " SDIMG_NAME
SDIMG_NAME=${SDIMG_NAME:-"sd.img"}

read -p "Enter SD card image size (use K,M,G for kB,MB,GB)? [1G] " SDIMG_SIZE
SDIMG_SIZE=${SDIMG_SIZE:-"1G"}

# create SD card image
echo "-------------------------------------------------------------------------"
echo " Creating SD card image ..."
echo "-------------------------------------------------------------------------"
qemu-img create ${SDIMG_NAME} ${SDIMG_SIZE}
echo "-------------------------------------------------------------------------"
echo "                        ... done!"
echo "-------------------------------------------------------------------------"

# partition SD card
echo "-------------------------------------------------------------------------"
echo " Creating SD card partitions ..."
echo "-------------------------------------------------------------------------"
sfdisk ${SDIMG_NAME} << EOF
,64M,0x0c,*
,,L,
EOF
echo "-------------------------------------------------------------------------"
echo "                             ... done!"
echo "-------------------------------------------------------------------------"

# insert SD card
echo "-------------------------------------------------------------------------"
echo " Mapping SD card image ..."
echo "-------------------------------------------------------------------------"
loop_nr=$(sudo kpartx -av ${SDIMG_NAME} | grep -Po 'loop.+?(?=p)' | tail -1)
sleep 1
echo $loop_nr
echo "-------------------------------------------------------------------------"
echo "                       ... done!"
echo "-------------------------------------------------------------------------"

# format partitions
echo "-------------------------------------------------------------------------"
echo " Formatting partitions ..."
echo "-------------------------------------------------------------------------"
sudo mkfs.vfat -n "boot" /dev/mapper/${loop_nr}p1
sudo mkfs.ext4 -L rootfs /dev/mapper/${loop_nr}p2
echo "-------------------------------------------------------------------------"
echo "                       ... done!"
echo "-------------------------------------------------------------------------"

# remove SD card
echo "-------------------------------------------------------------------------"
echo " Unmapping SD card image ..."
echo "-------------------------------------------------------------------------"
sudo kpartx -d ${SDIMG_NAME}
echo "-------------------------------------------------------------------------"
echo "                         ... done!"
echo "-------------------------------------------------------------------------"

echo "-------------------------------------------------------------------------"
echo "                Finished creating SD Card ${SDIMG_NAME}!"
echo "-------------------------------------------------------------------------"

)
